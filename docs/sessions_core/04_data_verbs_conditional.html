<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<link rel="alternate" hreflang="en" href="/sessions_core/04_data_verbs_conditional.html" />
<link rel="alternate" hreflang="fr" href="/fr/sessions_core/04_data_verbs_conditional.fr.html" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="description" content="Using {dplyr} and conditional logic to filter and recode data">
<title>Data Manipulation, Filtering and Recoding – {repicentre}</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>
<script src="../site_libs/quarto-nav/quarto-nav.js"></script><script src="../site_libs/quarto-nav/headroom.min.js"></script><script src="../site_libs/clipboard/clipboard.min.js"></script><script src="../site_libs/quarto-search/autocomplete.umd.js"></script><script src="../site_libs/quarto-search/fuse.min.js"></script><script src="../site_libs/quarto-search/quarto-search.js"></script><meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script><script src="../site_libs/quarto-html/popper.min.js"></script><script src="../site_libs/quarto-html/tippy.umd.min.js"></script><script src="../site_libs/quarto-html/anchor.min.js"></script><link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-0626ff4d7a71b55c8707dcae1d04a9b6.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-e25cc82807363e79c52e96bc8b7855f1.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script><link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b814d3e578892f16fb585af6f47f426f.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-35dfec4a88a4a8552367c65e80eaa027.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="../site_libs/font-awesome-6.5.2/js/script.js"></script><script type="text/javascript" src="../script.js"></script><link rel="stylesheet" href="../styles.css">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">{repicentre}</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item"><div class="dropdown" id="languages-links-parent">
<button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="languages-button"><i class="bi bi-globe2"></i> English</button><ul class="dropdown-menu" id="languages-links"><li><a class="dropdown-item" href="/fr/sessions_core/04_data_verbs_conditional.html" id="language-link-fr">Français</a></li></ul>
</div></li>
<li class="nav-item">
    <a class="nav-link" href="../pathway.html"> 
<span class="menu-text">Pathway</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../explore.html"> 
<span class="menu-text">Explore</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../resources.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#objectives" id="toc-objectives" class="nav-link active" data-scroll-target="#objectives">Objectives</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li>
<a href="#using-conditional-logic-to-filter-data" id="toc-using-conditional-logic-to-filter-data" class="nav-link" data-scroll-target="#using-conditional-logic-to-filter-data">Using Conditional Logic to Filter Data</a>
  <ul class="collapse">
<li><a href="#this-equals-that" id="toc-this-equals-that" class="nav-link" data-scroll-target="#this-equals-that">This Equals That</a></li>
  <li><a href="#this-does-not-equal-that" id="toc-this-does-not-equal-that" class="nav-link" data-scroll-target="#this-does-not-equal-that">This Does Not Equal That</a></li>
  <li><a href="#greater-than-less-than" id="toc-greater-than-less-than" class="nav-link" data-scroll-target="#greater-than-less-than">Greater Than / Less Than</a></li>
  <li><a href="#filters-with-multiple-conditions" id="toc-filters-with-multiple-conditions" class="nav-link" data-scroll-target="#filters-with-multiple-conditions">Filters with Multiple Conditions</a></li>
  <li><a href="#sec-logic-statements" id="toc-sec-logic-statements" class="nav-link" data-scroll-target="#sec-logic-statements">Summary of Basic Logic Statements</a></li>
  </ul>
</li>
  <li>
<a href="#recoding-with-case_when" id="toc-recoding-with-case_when" class="nav-link" data-scroll-target="#recoding-with-case_when">Recoding with <code>case_when()</code></a>
  <ul class="collapse">
<li><a href="#the-in-operator" id="toc-the-in-operator" class="nav-link" data-scroll-target="#the-in-operator">The %in% operator</a></li>
  </ul>
</li>
  <li><a href="#a-last-bit-of-cleanup" id="toc-a-last-bit-of-cleanup" class="nav-link" data-scroll-target="#a-last-bit-of-cleanup">A Last Bit of Cleanup</a></li>
  <li><a href="#done" id="toc-done" class="nav-link" data-scroll-target="#done">Done!</a></li>
  <li>
<a href="#going-further" id="toc-going-further" class="nav-link" data-scroll-target="#going-further">Going Further</a>
  <ul class="collapse">
<li><a href="#extra-exercises" id="toc-extra-exercises" class="nav-link" data-scroll-target="#extra-exercises">Extra Exercises</a></li>
  </ul>
</li>
  </ul></nav>
</div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">Data Manipulation, Filtering and Recoding</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Core</div>
    <div class="quarto-category">Data Manipulation</div>
    <div class="quarto-category">Data Cleaning</div>
    <div class="quarto-category">Logic</div>
  </div>
  </div>

<div>
  <div class="description">
    Using <code>{dplyr}</code> and conditional logic to filter and recode data
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="objectives" class="level2"><h2 class="anchored" data-anchor-id="objectives">Objectives</h2>
<ul>
<li>Understand basic conditional logic statements</li>
<li>Learn how to filter a data frame using <code>filter()</code>
</li>
<li>Learn how to recode variables using <code>case_when()</code>
</li>
</ul></section><section id="setup" class="level2"><h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p><strong>Dependencies.</strong> This session assumes that you know the basics of data manipulation with <code>{dplyr}</code>. If you need a refresher on this, please review the <a href="../sessions_core/03_data_verbs.html">third session in the learning pathway</a>.</p>
<div class="setup">
<p>This session will work with the <strong>raw</strong> Moissala linelist data, which can be downloaded here:</p>
<div class="cell">
<div class="cell-output-display">
<a href="https://github.com/epicentre-msf/repicentre/raw/refs/heads/main/data/raw/moissala_linelist_EN.xlsx">
<button class="btn btn-default"><i class="fa fa-save"></i>  Download Data</button>
</a>
</div>
</div>
<p><br> Make sure this dataset is saved into the appropriate subdirectory of your R project and create a new script called <code>filtering_and_recoding_practice.R</code> in your <code>R</code> directory. Add an appropriate header and load the following packages: <code>{here}</code>, <code>{rio}</code>, and <code>{tidyverse}</code>. <br><br> Finally, add an import section where you use <code>{here}</code> and <code>{rio}</code> to load your data into an object called <code>df_raw</code>.</p>
</div>
</section><section id="using-conditional-logic-to-filter-data" class="level2"><h2 class="anchored" data-anchor-id="using-conditional-logic-to-filter-data">Using Conditional Logic to Filter Data</h2>
<p>In the last session we learned a lot of the core data verbs in <code>{dplyr}</code> for basic manipulation tasks like selecting particular variables of interest and modifying them to better suit our needs. Beyond selecting <strong>variables of interest</strong>, another common task we have as epidemiologists is selecting <strong>observations of interest</strong>; ie: filtering our data to look at particular observations that meet a <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="For example, looking only at hospitalized patients or cases from a particular region.">certain criteria</span>.</p>
<p>Fortunately, <code>{dplyr}</code> has our back with the conveniently named function, <code>filter()</code>. To understand how to use it, however, we will need to learn a bit about how to construct <strong>conditional logic statements</strong> in R. This will be the focus of our session today.</p>
<section id="this-equals-that" class="level3"><h3 class="anchored" data-anchor-id="this-equals-that">This Equals That</h3>
<p>The basic syntax of <code>filter()</code> is pretty simple:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DO NOT RUN (PSEUDO-CODE)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>df_raw <span class="sc">|&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>([conditional logic statement]) <span class="co"># Keep lines where statement is TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>But what is a conditional logic statement? These are statements that ask “Is this thing true?”. The simplest conditional logic statement asks “does this variable equal this value?”. For example, “was this patient hospitalized?”. In R, we can ask if one value equals another <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Notice that there are **two** equals signs, not one.">using <code>==</code></span>.</p>
<p>To create a filter asking, for each observation, whether the value of <code>hospitalization</code> is equal to <code>yes</code> we can then use the following syntax:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df_raw <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(hospitalisation <span class="sc">==</span> <span class="st">'yes'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What <code>filter()</code> is doing here is going down each row of our dataset and asking: “for this row, is the value of <code>hospitalisation</code> equal to <code>"yes"</code>?”. It then returns only the rows where the answer to this question is <code>TRUE</code>.</p>
<div class="write">
<p>Create a filter that selects all of the patients who had a fever, ie: where the value of <code>fever</code> was <code>"Yes"</code>. The head of <code>fever</code> should look like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  fever
1   Yes
2   Yes
3   Yes
4   Yes
5   Yes
6   Yes</code></pre>
</div>
</div>
<p>Take a look at your output and then take a look at the head of <code>df_raw</code>. Why does <code>df_raw</code> still contain patients who didn’t present with fever?</p>
</div>
</section><section id="this-does-not-equal-that" class="level3"><h3 class="anchored" data-anchor-id="this-does-not-equal-that">This Does Not Equal That</h3>
<p>Checking if something is the same is great, but a lot of the time we might have another question in mind. For example, we might want to know how many patients <strong>didn’t recover</strong>, whether this was because they died or because they left against medical advice.</p>
<p>In this case, instead of writing <code>==</code> we will instead use <code>!=</code>. So, for example if we want to select all observations where patients <strong>didn’t</strong> recover we would write:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(outcome <span class="sc">!=</span> <span class="st">'recovered'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="write">
<p>Create a filter that selects patients who <strong>did not</strong> have a card confirmed vaccination status. The head of <code>vacc_status</code> should look like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  vacc_status
1          No
2  Yes - oral
3          No
4          No
5          No
6          No</code></pre>
</div>
</div>
<p><strong>Hint.</strong> Remember that you can use <code>count()</code> to check what the options were for <code>vacc_status</code>.</p>
</div>
</section><section id="greater-than-less-than" class="level3"><h3 class="anchored" data-anchor-id="greater-than-less-than">Greater Than / Less Than</h3>
<p>The other common question we have is whether a value was greater or less than a particular threshold. For example, how many patients were under 5 years old? Here we will use <code>&lt;</code> and <code>&gt;</code> to evaluate whether a variable is <strong>less than</strong> or <strong>greater than</strong> a particular value, respectively.</p>
<p>For example, to ask how many patients were <strong>less than</strong> <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Checking the number of patients under/over five years old is a common indicator when analysing measles data.">60 months old</span> we can write:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df_raw <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age <span class="sc">&lt;</span> <span class="dv">60</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="write">
<p>Create a filter that selects all patients with severe accute malnutrition (ie: patients with a MUAC less than 110). The head of <code>muac</code> should look like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  muac
1   80
2   88
3   60
4   85
5   86
6   68</code></pre>
</div>
</div>
<p>Now create another filter that selects patients who are over <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="15 years is the same as 180 months.">15 years old</span>. The head of your age column should look like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  age
1 348
2 348
3 312
4 432
5 444
6 324</code></pre>
</div>
</div>
</div>
<p>Sometimes, instead of asking if something is less or greater than a particular value, we want to ask if it is less than or equal to that value. Easy, we just need to add an equal sign! We write <code>&lt;=</code> for “less than or equal to” and <code>&gt;=</code> for “greater than or equal to”. Careful here, the <code>=</code> must come after <code>&lt;</code> or <code>&gt;</code>, not before.</p>
<p>So if we want to ask for how many patients were <strong>10 years of age or younger</strong>, we can write:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df_raw <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age <span class="sc">&lt;=</span> <span class="dv">120</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="write">
<p>Create a filter that selects all patients with a normal nutrition status, ie: patients with a <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="For simplicity and given the limitations of our data, we will use a MUAC only definition of 'normal nutritional status'.">MUAC greater than or equal to 125</span>. The head of <code>muac</code> should look like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  muac
1  244
2  232
3  210
4  220
5  152
6  155</code></pre>
</div>
</div>
</div>
</section><section id="filters-with-multiple-conditions" class="level3"><h3 class="anchored" data-anchor-id="filters-with-multiple-conditions">Filters with Multiple Conditions</h3>
<p>Want to combine several logic statements in a single filter? Easy. We can create a filter with multiple conditions by simply <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="And by putting it on its own line for good readability.">separating each condition with a comma</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DO NOT RUN (PSEUDO-CODE)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>([condition <span class="dv">1</span>],</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>         [condition <span class="dv">2</span>],</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>         [condition <span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So for example, let’s say we want to select all patients <strong>under five who were hospitalized</strong>. In this case we can write:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_raw <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(age <span class="sc">&lt;</span> <span class="dv">5</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">hospitalised =</span> <span class="st">"true"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="write">
<p>Create a filter that selects all patients with severe accute malnutrition who were hospitalized in the Koumra health facility. The head of <code>id</code>, <code>sub_prefecture</code>, <code>hospitalisation</code>, and <code>muac</code> should look like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>    id sub_prefecture hospitalisation muac
1 8624         KOUMRA             yes  103
2 8939         KOUMRA             yes   67
3 9957         KOUMRA             yes   71</code></pre>
</div>
</div>
<p><strong>Hint.</strong> This filter has a condition on both <code>hospitalisation</code> status, <code>sub_prefecture</code>, <strong>and</strong> <code>muac</code>.</p>
</div>
</section><section id="sec-logic-statements" class="level3"><h3 class="anchored" data-anchor-id="sec-logic-statements">Summary of Basic Logic Statements</h3>
<p>Good job working through a quick tour of logic statements in R! Here is a handy table to help you remember the main logic statements we have learned so far:</p>
<table class="caption-top table">
<thead><tr class="header">
<th style="text-align: left;">Statement</th>
<th style="text-align: center;">R</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Is A the same as B?</td>
<td style="text-align: center;">A == B</td>
</tr>
<tr class="even">
<td style="text-align: left;">Is A <strong>not</strong> the same as B</td>
<td style="text-align: center;">A != B</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Is A greater than B?</td>
<td style="text-align: center;">A &gt; B</td>
</tr>
<tr class="even">
<td style="text-align: left;">Is A greater than or equal to B?</td>
<td style="text-align: center;">A &gt;= B</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Is A less than B?</td>
<td style="text-align: center;">A &lt; B</td>
</tr>
<tr class="even">
<td style="text-align: left;">Is A less than or equal to B?</td>
<td style="text-align: center;">A &lt;= B</td>
</tr>
</tbody>
</table></section></section><section id="recoding-with-case_when" class="level2"><h2 class="anchored" data-anchor-id="recoding-with-case_when">Recoding with <code>case_when()</code>
</h2>
<p>As we have seen, conditional logic statements are incredibly useful when trying to filter our data, but you will find that they have many other uses as well. One of their other major use cases for us as epidemiologists is when we need to <span class="hovertip" data-bs-toggle="tooltip" data-bs-title='Recoding is the process of either standardizing the values of variable (such as making sure "f" and "female" are both coded as "F") or creating standardized groups of variable values (for example age groups).'>recode our data</span>. This is where the <code>{dplyr}</code> function <code>case_when()</code> is here to help us.</p>
<p>The syntax of <code>case_when()</code> is a little more advanced than what we have seen so far, but we will go slowly and break it down. Once you get the hang of it, <code>case_when()</code> will become a very powerful part of your R toolbelt.</p>
<p>We will almost always use <code>case_when()</code> inside of a <code>mutate()</code>, because we will use it either to recode an existing variable or to create a new one. The basic syntax works like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DO NOT RUN (PSEUDO-CODE)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">column_name =</span> <span class="fu">case_when</span>([first condition] <span class="sc">~</span> [value when condition is <span class="cn">TRUE</span>],</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                                 [second condition] <span class="sc">~</span> [value when second condition is <span class="cn">TRUE</span>],</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">.default =</span> [default value])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ok, that’s a lot. Let’s break it down.</p>
<p>So the first thing to notice is that, with the exception of the last line, each line inside of <code>case_when()</code> has the following format:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>[condition] <span class="sc">~</span> [value when condition is <span class="cn">TRUE</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So for example, if we want our <code>case_when()</code> to say that anytime a patient had a MUAC less than 110 we want to have a value of <code>"SAM"</code>, we would have something like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>muac <span class="sc">&lt;</span> <span class="dv">110</span> <span class="sc">~</span> <span class="st">'SAM'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can add multiple possible outcomes by adding additional lines. In this case, our next condition might check if the patient is moderately but not severly malnourished using the statement <code>muac &lt; 125 ~ 'MAM'</code>.</p>
<p>The last line, with the argument <code>.default</code> gives the value we want <code>case_when()</code> to use when none of the above conditions have been met. In this case, we might give the value <code>'Normal'</code>.</p>
<p>To put this together, if we wanted to create a variable that classifies the malnutrition status of patients using their MUAC, we would write:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df_raw <span class="sc">|&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">malnut =</span> <span class="fu">case_when</span>(muac <span class="sc">&lt;</span> <span class="dv">110</span> <span class="sc">~</span> <span class="st">'SAM'</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                            muac <span class="sc">&lt;</span> <span class="dv">125</span> <span class="sc">~</span> <span class="st">'MAM'</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                            <span class="at">.default =</span> <span class="st">'Normal'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="write">
<p>Try running the above code to see if it successfully creates a new column <code>malnut</code> with the malnutrition status of each case. You should get something like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  muac malnut
1  244 Normal
2  232 Normal
3  123    MAM
4  210 Normal
5   80    SAM
6  220 Normal</code></pre>
</div>
</div>
</div>
<p><strong>Be careful.</strong> The order of your statements is important here. What <code>case_when()</code> will do is go through each statement from top to bottom and assign the first value that is <code>TRUE</code>. So in our above example, <code>case_when()</code> will ask the following questions in sequence:</p>
<ul>
<li>Does this patient have SAM (is <code>muac &lt; 110</code>)? <strong>If so</strong>, assign the value <code>"SAM"</code>
</li>
<li>
<strong>If the patient didn’t have SAM</strong>, do they have MAM (is <code>muac &lt; 125</code>)? <strong>If so</strong>, assign the value `“MAM”</li>
<li>
<strong>If none of the above conditions were true</strong>, assign the default value <code>"Normal"</code>
</li>
</ul>
<div class="write">
<p>Try reordering the first and second conditions in the above <code>case_when()</code> so that you first check if <code>muac &lt; 125</code>. The head of your new data frame should now look like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  muac malnut
1  244 Normal
2  232 Normal
3  123    MAM
4  210 Normal
5   80    MAM
6  220 Normal</code></pre>
</div>
</div>
<p>Notice anything different? Save this new data frame to a <code>tmp</code> object and inspect it to see if we still have any patients classified as <code>"SAM"</code>. Can you figure out why this no longer gives the correct classification?</p>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>.default</code> argument in <code>case_when()</code> is not obligatory. If you don’t include it then <code>case_when()</code> will use <code>NA</code> by default.</p>
</div>
</div>
<p>As we saw in our above example, <code>case_when()</code> is an easy way of creating new variables based on the values of an existing column. This can be used to classify status (as we saw with malnutrition) or to regroup variables into categories (like age groups).</p>
<div class="write">
<p>Use <code>case_when()</code> to create a new variable <code>age_group</code> with three categories: <code>"&lt; 5 Years"</code>, <code>"5 - 15 Years"</code>, and <code>"&gt; 15 Years"</code>. Patients missing age data should be assigned a default value of <code>"Unknown"</code>. <strong>Be careful with your ordering!</strong> The head of your new column should look like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  age     age_group
1  36     &lt; 5 Years
2   5     &lt; 5 Years
3 156 5 - 15  Years
4   8     &lt; 5 Years
5   7     &lt; 5 Years
6   4     &lt; 5 Years</code></pre>
</div>
</div>
</div>
<section id="the-in-operator" class="level3"><h3 class="anchored" data-anchor-id="the-in-operator">The %in% operator</h3>
<p>So now we can regroup variables into categories, great. But we can also use <code>case_when()</code> to standardize the values we see in a variable.</p>
<div class="write">
<p>Using <code>count()</code> inspect the categorical variables in <code>df_raw</code> to check if any have inconsistencies in their coding.</p>
</div>
<p>In our dataset, we see that there are some issues in the way <code>sex</code> was coded. For example, female patients are coded as <code>f</code>, <code>female</code> and <code>femme</code>. That simply won’t do. Thankfully, we can use <code>case_when()</code> to recode this variable. This time, instead of creating a new variable we will directly update <code>sex</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>df_raw <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sex =</span> <span class="fu">case_when</span>(sex <span class="sc">==</span> <span class="st">"f"</span> <span class="sc">~</span> <span class="st">"Female"</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                         sex <span class="sc">==</span> <span class="st">"female"</span> <span class="sc">~</span> <span class="st">"Female"</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                         sex <span class="sc">==</span> <span class="st">"femme"</span> <span class="sc">~</span> <span class="st">"Female"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                         sex <span class="sc">==</span> <span class="st">"m"</span> <span class="sc">~</span> <span class="st">"Male"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                         sex <span class="sc">==</span> <span class="st">"male"</span> <span class="sc">~</span> <span class="st">"Male"</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>                         sex <span class="sc">==</span> <span class="st">"homme"</span> <span class="sc">~</span> <span class="st">"Male"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">.default =</span> <span class="st">"Unknown"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Well, that works, but it seems awfully repetitive. It would be easier if we could just list all the options that we want to reassign to “Female” and “Male” respectively. This is where the <code>%in%</code> operator is here to help. The <code>%in%</code> operator will check if a value is in a vector of options using the following basic syntax:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DO NOT RUN (PSEUDO-CODE)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>[value] <span class="sc">%in%</span> [vector_of_options]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So, for example, we could check if the value <code>"f"</code> is in the options <code>"f"</code>, <code>"female"</code> using the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="st">"f"</span> <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"f"</span>, <span class="st">"female"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="write">
<p>Try running the above statement. What is the data type of your outcome?</p>
</div>
<p>See how the outcome of the above statement is a <code>boolean</code>, ie: a logic outcome? That means we can use it as a condition in <code>case_when()</code>! This means that our verbose code above can now be written as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df_raw <span class="sc">|&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">sex =</span> <span class="fu">case_when</span>(sex <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"f"</span>, <span class="st">"female"</span>, <span class="st">"femme"</span>) <span class="sc">~</span> <span class="st">"Female"</span>,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                         sex <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"m"</span>, <span class="st">"male"</span>, <span class="st">"homme"</span>) <span class="sc">~</span> <span class="st">"Male"</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">.default =</span> <span class="st">"Unknown"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Much nicer.</p>
<div class="write">
<p>Use <code>case_when()</code> and the <code>%in%</code> operator to create a new column <code>vacc_status_strict</code> that has the value <code>"Yes"</code> for cases with <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Had a vacc_status of 'Yes - card'"><strong>card confirmed</strong> vaccination status</span>, <code>"No"</code> for cases who said they were <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Had a vacc_status of 'No'">unvaccinated</span>, and <code>"Unverified"</code> otherwise. The head of your new column should look like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  vacc_status_strict
1         Unverified
2                 No
3         Unverified
4                 No
5                 No
6                 No</code></pre>
</div>
</div>
</div>
</section></section><section id="a-last-bit-of-cleanup" class="level2"><h2 class="anchored" data-anchor-id="a-last-bit-of-cleanup">A Last Bit of Cleanup</h2>
<p>Now that we know how to leverage <code>case_when()</code> and conditional logic (in addition to what we learned in the <a href="../sessions_core/03_data_verbs.html">last session</a>, we can actually put together a decent cleaning pipeline. I hope you kept your code from last time handy…</p>
<div class="write">
<p>Using what you have learned above and what you practiced in the last session, create a basic data cleaning pipe that creates a new data frame, <code>df</code>, after doing the following:</p>
<ul>
<li>Remove the variables <code>full_name</code> and <code>age_unit</code>
</li>
<li>Rename the following variables:
<ul>
<li>
<code>age</code> becomes <code>age_months</code>
</li>
<li>
<code>sub_prefecture</code> becomes <code>prefecture</code>
</li>
<li>
<code>village_commune</code> becomes <code>village</code>
</li>
<li>
<code>health_facility_name</code> becomes <code>facility</code>
</li>
</ul>
</li>
<li>Add a variable <code>age_years</code> with patient age in years</li>
<li>Update <code>region</code> and <code>prefecture</code> to use title case</li>
<li>Update all date columns to use <code>Date</code> type</li>
<li>Create a new variable <code>age_group</code> age to include the groups: &lt; 6 months, 6 - 11 months, 12 - 59 months, 5 - 15 years, and &gt; 15 years (patients with unknown age should have a value “Unknown”)</li>
<li>Recode sex to have only the values: Female, Male, and Unknown</li>
<li>Remove any duplicate observations</li>
</ul>
<p>The head of your final data should look something like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  id    sex age_months  region prefecture        village date_onset
1  1 Female         36 Mandoul   Moissala Sangana Koïtan 2022-08-13
2  2 Female          5 Mandoul   Moissala      Mousdan 1 2022-08-18
3  3 Female        156 Mandoul   Moissala     Djaroua Ii 2022-08-17
4  6   Male          8 Mandoul   Moissala     Monakoumba 2022-08-22
5  7   Male          7 Mandoul   Moissala      Tétindaya 2022-08-30
6 10   Male          4 Mandoul   Moissala      Danamadja 2022-08-30
  date_consultation hospitalisation date_admission
1        2022-08-14             yes     2022-08-14
2        2022-08-25             yes     2022-08-25
3        2022-08-20            &lt;NA&gt;           &lt;NA&gt;
4        2022-08-25              no           &lt;NA&gt;
5        2022-09-02              no           &lt;NA&gt;
6        2022-09-02             yes     2022-09-02
                         facility malaria_rdt fever rash cough red_eye
1 Hôpital du District de Moissala    negative    No &lt;NA&gt;   Yes      No
2 Hôpital du District de Moissala    negative    No   No   Yes      No
3                      CS Silambi    negative   Yes &lt;NA&gt;    No      No
4 Hôpital du District de Moissala    negative    No   No    No    &lt;NA&gt;
5                      CS Silambi    negative  &lt;NA&gt;   No   Yes     Yes
6                    Moissala Est    negative   Yes   No    No    &lt;NA&gt;
  pneumonia encephalitis muac vacc_status vacc_doses   outcome date_outcome
1        No           No  244        &lt;NA&gt;       &lt;NA&gt; recovered   2022-08-18
2      &lt;NA&gt;           No  232          No       &lt;NA&gt;      &lt;NA&gt;   2022-08-28
3        No         &lt;NA&gt;  123  Yes - oral       &lt;NA&gt; recovered         &lt;NA&gt;
4        No           No  210          No       &lt;NA&gt; recovered         &lt;NA&gt;
5        No           No   80          No       &lt;NA&gt; recovered         &lt;NA&gt;
6        No           No  220          No       &lt;NA&gt; recovered   2022-09-03
   age_years      age_group
1  3.0000000 12 - 59 months
2  0.4166667     &lt; 6 months
3 13.0000000   5 - 15 years
4  0.6666667  6 - 11 months
5  0.5833333  6 - 11 months
6  0.3333333     &lt; 6 months</code></pre>
</div>
</div>
</div>
<p>Amazing! Let’s look at how to save this (mostly) clean dataset. Here, we will use the function <code>export()</code> from <code>{rio}</code> and <code>here()</code> from <code>{here}</code> to specify where to save our output:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">export</span>(<span class="fu">here</span>(<span class="st">'data'</span>, <span class="st">'clean'</span>, <span class="st">'measles_linelist_clean.xlsx'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice here that we are putting our data in the appropriate <code>clean</code> subfolder of <code>data</code>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the above example we save our data as an <code>xlsx</code>, which is helpful if you want to be able to open the clean data in Excel. Often, however, we might prefer to use a file with the extension <code>.rds</code> instead. This is a file type specific to R and is more robust to issues related to encoding or date formatting than files like <code>xlsx</code> or <code>csv</code>. To save your above file as an <code>rds</code> all you need to do is change the extension:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">export</span>(<span class="fu">here</span>(<span class="st">'data'</span>, <span class="st">'clean'</span>, <span class="st">'measles_linelist_clean.rds'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section><section id="done" class="level2"><h2 class="anchored" data-anchor-id="done">Done!</h2>
<p>Very well done. You’ve learned how to use basic data verbs, conditional logic, and create a basic data cleaning pipeline.</p>
<div class="cell">
<div class="cell-output-display">
<a href="https://github.com/epicentre-msf/repicentre/blob/main/sessions_core/03_data_verbs_conditional_solutions.R">
<button class="btn btn-default"><i class="fa fa-save"></i> Solution File</button>
</a>
</div>
</div>
</section><section id="going-further" class="level2"><h2 class="anchored" data-anchor-id="going-further">Going Further</h2>
<section id="extra-exercises" class="level3"><h3 class="anchored" data-anchor-id="extra-exercises">Extra Exercises</h3>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body>
</html>
