<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<link rel="alternate" hreflang="en" href="/sessions_core/03_data-verbs.html" />
<link rel="alternate" hreflang="fr" href="/fr/sessions_core/03_data-verbs.fr.html" />
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-02-11">
<meta name="description" content="An introduction to data manipulation and cleaning using {dplyr}">

<title>Basic Data Manipulation – {repicentre}</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-0626ff4d7a71b55c8707dcae1d04a9b6.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-e25cc82807363e79c52e96bc8b7855f1.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b814d3e578892f16fb585af6f47f426f.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-35dfec4a88a4a8552367c65e80eaa027.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://hypothes.is/embed.js"></script>
<script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script>
<script src="../site_libs/font-awesome-6.5.2/js/script.js"></script>
<script type="text/javascript" src="../script.js"></script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">{repicentre}</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../pathway.html"> 
<span class="menu-text">Pathway</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../explore.html"> 
<span class="menu-text">Explore</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../resources.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#objectives" id="toc-objectives" class="nav-link active" data-scroll-target="#objectives">Objectives</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#manipulating-data-with-dplyr" id="toc-manipulating-data-with-dplyr" class="nav-link" data-scroll-target="#manipulating-data-with-dplyr">Manipulating Data with <code>{dplyr}</code></a>
  <ul class="collapse">
  <li><a href="#what-is-dplyr" id="toc-what-is-dplyr" class="nav-link" data-scroll-target="#what-is-dplyr">What is <code>{dplyr}</code></a></li>
  </ul></li>
  <li><a href="#basic-data-verbs" id="toc-basic-data-verbs" class="nav-link" data-scroll-target="#basic-data-verbs">Basic Data Verbs</a>
  <ul class="collapse">
  <li><a href="#selecting-specific-columns" id="toc-selecting-specific-columns" class="nav-link" data-scroll-target="#selecting-specific-columns">Selecting Specific Columns</a></li>
  <li><a href="#renaming-columns" id="toc-renaming-columns" class="nav-link" data-scroll-target="#renaming-columns">Renaming Columns</a></li>
  <li><a href="#changing-and-adding-columns" id="toc-changing-and-adding-columns" class="nav-link" data-scroll-target="#changing-and-adding-columns">Changing and Adding Columns</a></li>
  <li><a href="#removing-duplicates" id="toc-removing-duplicates" class="nav-link" data-scroll-target="#removing-duplicates">Removing Duplicates</a></li>
  </ul></li>
  <li><a href="#the-pipe-operator" id="toc-the-pipe-operator" class="nav-link" data-scroll-target="#the-pipe-operator">The Pipe Operator</a></li>
  <li><a href="#done" id="toc-done" class="nav-link" data-scroll-target="#done">Done!</a></li>
  <li><a href="#going-further" id="toc-going-further" class="nav-link" data-scroll-target="#going-further">Going Further</a>
  <ul class="collapse">
  <li><a href="#extra-exercises" id="toc-extra-exercises" class="nav-link" data-scroll-target="#extra-exercises">Extra Exercises</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Basic Data Manipulation</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Core</div>
    <div class="quarto-category">Data Manipulation</div>
    <div class="quarto-category">Data Cleaning</div>
  </div>
  </div>

<div>
  <div class="description">
    An introduction to data manipulation and cleaning using <code>{dplyr}</code>
  </div>
</div>


<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 11, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="objectives" class="level2">
<h2 class="anchored" data-anchor-id="objectives">Objectives</h2>
<ul>
<li>Learn basic data verbs from <code>{dplyr}</code> to:
<ul>
<li>Select specific columns (<code>select()</code>)</li>
<li>Rename columns (<code>rename()</code>)</li>
<li>Add new columns and change existing ones (<code>mutate()</code>)</li>
<li>Remove duplicate observations</li>
</ul></li>
<li>Understand the pipe operator <code>|&gt;</code></li>
</ul>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p><strong>Dependencies.</strong> This session assumes that you know how to use RStudio and that you are able to import data. If you need a refresher on either of these topics, we encourage you to review the <a href="https://epicentre-msf.github.io/repicentre/pathway.html">first two sessions in the learning pathway</a>.</p>
<div class="setup">
<p>This session will work with the <strong>raw</strong> Moissala linelist data, which can be downloaded here:</p>
<div class="cell">
<div class="cell-output-display">
<a href="https://github.com/epicentre-msf/repicentre/raw/refs/heads/main/data/raw/moissala_linelist_EN.xlsx">
<button class="btn btn-default"><i class="fa fa-save"></i>  Download Data</button>
</a>
</div>
</div>
<p><br> Make sure this dataset is saved into the appropriate subdirectory of your R project and create a new script called <code>data_verbs_practice.R</code> in your <code>R</code> directory. Add an appropriate header and load the following packages: <code>{here}</code>, <code>{rio}</code>, and <code>{tidyverse}</code>. <br><br> Finally, add an import section where you use <code>{here}</code> and <code>{rio}</code> to load your data into an object called <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Note, that we are calling this our raw data, not `df_linelist` as we did previously. You will see why later."><code>df_raw</code></span>.</p>
</div>
</section>
<section id="manipulating-data-with-dplyr" class="level2">
<h2 class="anchored" data-anchor-id="manipulating-data-with-dplyr">Manipulating Data with <code>{dplyr}</code></h2>
<p>Now that we know how to set up a project and import data, we can finally start to play around with it. Going forward we will be using several packages from the “<span class="hovertip" data-bs-toggle="tooltip" data-bs-title="The tidyverse is a collection of packages that are designed for maximum human readability and user friendliness. Check out their website for more information on what's available.">tidyverse</span>” to help us manipulate, summarize, and visualize our data. Today’s session will focus on data manipulation using a package called <code>{dplyr}</code>.</p>
<section id="what-is-dplyr" class="level3">
<h3 class="anchored" data-anchor-id="what-is-dplyr">What is <code>{dplyr}</code></h3>
<p>Data manipulation is the foundation of <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Or really any other language, including Excel!">working with data in R</span> and as such is foundational to the work we do as epidemiologists. In particular, data manipulation skills will be critical when trying clean our data.</p>
<p>In R, the package <code>{dplyr}</code> provides a large number of functions to help us manipulate data frames and perform many of the tasks that we will need to use on a daily basis, for example:</p>
<ul>
<li>Subsetting our data to remove certain <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Remember that each variable is a column in the context of a data frame">variables</span></li>
<li>Renaming certain variables</li>
<li>Adding or modifying a variable</li>
<li>Removing duplicate entries</li>
</ul>
<p>In <code>{dplyr}</code> each of these actions can be done with a particular function, which typically have an <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="These verbs, as with everything in R, are in English and will admittedly be less intuitive for learners coming from a non-anglophone background.">intuitive verb for a name</span>. For example, renaming columns will use the function <code>rename()</code>.</p>
<p>In today’s session we will look at the “data manipulation verb”, ie the function, needed for each of the above tasks as well as how to chain them all together into an efficient data pipeline.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>You may have noticed that we asked you to load a package called <code>{tidyverse}</code> rather than <code>{dplyr}</code> in the setup. Loading <code>{tidyverse}</code> will load <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="The tidyverse is pretty big and loading *all* of it's contents would be impractical for most projects. The package `{tidyverse}` therefore only loads the most useful 'core' packages from the full collection.">several of the most useful packages</span> from the broader tidyverse, including <code>{dplyr}</code> and a couple other packages that we will see later in the session.</p>
</div>
</div>
</section>
</section>
<section id="basic-data-verbs" class="level2">
<h2 class="anchored" data-anchor-id="basic-data-verbs">Basic Data Verbs</h2>
<section id="selecting-specific-columns" class="level3">
<h3 class="anchored" data-anchor-id="selecting-specific-columns">Selecting Specific Columns</h3>
<p>A lot of the time when we receive a dataset it will have extra columns that we don’t need, either because those columns contain <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Like patient names, for example">sensitive data</span> or because our analysis will only focus on a subset of the data. This is where a function like <code>select()</code> comes in handy.</p>
<p>Here is the basic syntax, note that this is <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Pseudo-code is used to show model syntax but isn't designed to actually be run. Often it will use stand in names like `column_name` to illustrate a concept. In this session and following ones we will often use pseudo-code to demonstrate the basic syntax of new functions as they are introduced.">pseudo-code</span> and isn’t something you are intended to run yourself.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DO NOT RUN (PSEUDO-CODE)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(df_raw, first_column_to_keep, second_column_to_keep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here we see that the first argument is our dataset and each subsequent argument is the name of a column that we would like to keep. In the tidyverse, variables (ie column names) don’t need to be put into quotation marks. So for example, if we want to select the columns <code>id</code>, <code>sex</code>, and <code>age</code> we can use the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(df_raw, id, sex, age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="write">
<p>Use <code>select()</code> to select the following variables in your dataset: <code>id</code>, <code>sex</code>, <code>age</code>, <code>sub_prefecture</code>, <code>date_onset</code>, and <code>outcome</code>. The head of your output should look something like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  id   sex age date_onset   outcome
1  1 femme  36 2022-08-13 recovered
2  2     f   5 2022-08-18      &lt;NA&gt;
3  3     f 156 2022-08-17 recovered
4  6 homme   8 2022-08-22 recovered
5  7     m   7 2022-08-30 recovered
6 10     m   4 2022-08-30 recovered</code></pre>
</div>
</div>
<p><br> Take a look at this output and then at <code>df_raw</code>. We can see that <code>df_raw</code> still contains all of the columns, which is what we want. But can you tell why it didn’t change?</p>
</div>
<p>Often, we want to keep most of the variables in our dataset and only remove one or two. We can use the above syntax to do this, but it can become pretty tedious to <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Anyone who has worked with complex linelists or survey data can certainly feel the pain here.">write out every column name</span>. In these cases, instead of telling <code>select what to **keep**, we can use a subtraction sign (</code>-<code>) to tell it what to **remove**. For example, if we wanted to remove the</code>village_commune` column from our dataframe we can use the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(df_raw, <span class="sc">-</span>village_commune)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Way easier!</p>
<div class="write">
<p>Use the <code>-</code> syntax in <code>select()</code> to select all of the columns in <code>df_raw</code> <strong>except</strong>: <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="In general, full names and other identifiable information should be removed immediately when working with linelist data."><code>full_name</code></span> and <code>age_unit</code> from your dataset.</p>
</div>
</section>
<section id="renaming-columns" class="level3">
<h3 class="anchored" data-anchor-id="renaming-columns">Renaming Columns</h3>
<p>Another common issue when we get new datasets is that the variable names are <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="This could be because they are too long, or worse because they contain spaces or accents">inconvenient</span>. In those cases, <code>rename()</code> can work wonders. Here’s the basic syntax:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DO NOT RUN (PSEUDO CODE)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rename</span>(df,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">new_column_name =</span> old_column_name,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">another_new_name =</span> another_old_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As in the case of <code>select()</code>, and indeed in essentially all <code>{dplyr}</code> verbs, the first argument is our daframe. Then each subsequent argument is a statement of <code>new_column_name = old_column_name</code> telling R which columns to rename and the new names that we want to use, with each pair given its own line to improve readability. If we wanted to change <code>village_commune</code> to simply be <code>village</code>, for example, we can write:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rename</span>(df_raw,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">village =</span> village_commune)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="write">
<p>Use <code>rename()</code> on <code>df_raw</code> to change the columns <code>sub_prefecture</code>, <code>village_commune</code>, and <code>health_facility_name</code> to be <code>prefecture</code>, <code>village</code>, and <code>facility</code> respectively.</p>
</div>
<p>In the above exercise it may have been difficult to check if the output looked correct because R would have printed out the full data frame. In these cases it can be helpful to create a temporary object just to check if everything looks alright. You can call this object whatever you want, but a common name is <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Here `tmp` stands for 'temporary'."><code>tmp</code></span>.</p>
<div class="write">
<p>Repeat the last exercise but this time assign the output to an object called <code>tmp</code> and use <code>names()</code> to check that the column names changed as you expected. The output of <code>names()</code> should give you something like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code> [1] "id"                "full_name"         "sex"              
 [4] "age"               "age_unit"          "region"           
 [7] "prefecture"        "village"           "date_onset"       
[10] "date_consultation" "hospitalisation"   "date_admission"   
[13] "facility"          "malaria_rdt"       "fever"            
[16] "rash"              "cough"             "red_eye"          
[19] "pneumonia"         "encephalitis"      "muac"             
[22] "vacc_status"       "vacc_doses"        "outcome"          
[25] "date_outcome"     </code></pre>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Temporary objects, like the <code>tmp</code> data frame you just created are just that: temporary. They are usually used to test if something has worked and designed to be overwritten each time you need to test something else. As such, you should not use these temporary objects as the input for other parts of your code. If you want to make a data frame that will be reused, such as a clean version of <code>df_raw</code>, this should be done using an object with a proper name like <code>df</code> or <code>df_clean</code>.</p>
</div>
</div>
</section>
<section id="changing-and-adding-columns" class="level3">
<h3 class="anchored" data-anchor-id="changing-and-adding-columns">Changing and Adding Columns</h3>
<p>So now we know how to select and rename columns, but how do we modify them? This is where <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="This name is admittedly less intuitive that other `{dplyr}` verbs. It is called mutate because you are changing (or 'mutating', if you will) parts of the data."><code>mutate()</code></span> comes into play. This function can be used both to add new columns and to change existing ones.</p>
<p>Let’s start with the basic <code>mutate()</code> syntax needed to add a new column:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DO NOT RUN (PSEUDO-CODE)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(df,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">new_column =</span> <span class="fu">action</span>(existing_column),</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">another_new_column =</span> <span class="fu">another_action</span>(another_existing_column))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the above code, we are creating a new column (<code>new_column</code>) by performing some sort of action (<code>action()</code>) on an existing column in the dataframe (<code>existing_column</code>). This action could be anything, it could use a function or be a simple arithmetic operation and can use one or more columns. For example, if we wanted to create a new column expressing <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="This is obviously an indicator you probably wouldn't need in practice, but is used here just to illustrate the use of mutate().">MUAC in cm</span> we could use the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(df_raw,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">muac_cm =</span> muac <span class="sc">/</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="write">
<p>Use <code>mutate()</code> to create a new column called <code>age_years</code> that expresses <code>age</code> in years rather than months. The head of your new <code>age_years</code> column should look like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>   age_years
1  3.0000000
2  0.4166667
3 13.0000000
4  0.6666667
5  0.5833333
6  0.3333333</code></pre>
</div>
</div>
</div>
<p>Great! But what if instead of creating a new column we instead wanted to change an existing one? You just need to use the existing column name on the left side of the <code>=</code> instead of giving a new column name. For example, in the above MUAC code we would write:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(df_raw,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">muac =</span> muac <span class="sc">/</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We might want to keep age in months as well as years, so we won’t reassign that column. But there are some other columns that could stand to be changed. There are a lot of reasons we might want to change a column, two of the most common ones are:</p>
<ol type="1">
<li>The format of a string needs changing</li>
<li>The data type of a column is incorrect</li>
</ol>
<p>Our dataset has both of these problems. For example, while it isn’t per se a problem that <code>region</code> and <code>sub_prefecture</code> are in all capitals, it also isn’t <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Also, inconsistent capitalization is a common type of dirtiness in datasets and standardizing by making everything lower case or title case can be a useful part of cleaning.">particularly nice</span>. To fix this, we can use another function from the <code>{tidyverse}</code>, this time from a package called <code>{stringr}</code> to make these columns <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Title case is when the first letter of each word is capitalized in the way you would see for the title of a book.">title case</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(df_raw,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">region =</span> <span class="fu">str_to_title</span>(region),</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">sub_prefecture =</span> <span class="fu">str_to_title</span>(sub_prefecture))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="write">
<p>Use <code>mutate()</code> to update the format of <code>malaria_rdt</code> and <code>outcome</code> to use title case. The head of these two columns should now look something like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  malaria_rdt   outcome
1    Negative Recovered
2    Negative      &lt;NA&gt;
3    Negative Recovered
4    Negative Recovered
5    Negative Recovered
6    Negative Recovered</code></pre>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Notice that we didn’t need to load <code>{stringr}</code> to do the above exercise. That’s because, like <code>{dplyr}</code> this package is loaded when we load the <code>{tidyverse}</code>.</p>
</div>
</div>
<p>That’s nicer. Now let’s consider the second issue, having variables with the wrong type.</p>
<div class="look">
<p>Take a look at the data type of your columns, do any of them look strange? <br><br> <strong>Hint.</strong> <code>str()</code> may be useful here.</p>
</div>
<p>Most of the columns look ok, but it seems theres something strange with the dates. Some of them are character type and others are something called <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="This is a data type in R that is sometimes used to express dates. It isn't the most convenient way of date handling, though the reasons why are a bit outside of the scope of this course. In general we recommend converting `POSIXct` to `Date` whenever working with dates.">POSIXct</span>. We would much rather have all of these columns use the simple <code>Date</code> type.</p>
<p>To convert to dates, we are going to call on yet <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="As you can see, the tidyverse contians a lot of convenient packages to make our lives as epidemiologists easier.">another package from the the tidyverse, <code>{lubridate}</code></span>. In particular, we are going to use the <span class="hovertip" data-bs-toggle="tooltip" data-bs-title="Here the name of the function indicates that it expects dates to be formated as year-month-day. Other functions are available in {lubridate} for dates that are constructed differently.">function <code>ymd()</code></span>. For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(df_raw,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">date_outcome =</span> <span class="fu">ymd</span>(date_outcome))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="write">
<p>Use <code>mutate()</code> and <code>ymd()</code> to modify <code>date_onset</code> and <code>date_admission</code> to be <code>Date</code> type. Use a temporary data frame <code>tmp</code> to check that your code is doing what you want it to.</p>
</div>
</section>
<section id="removing-duplicates" class="level3">
<h3 class="anchored" data-anchor-id="removing-duplicates">Removing Duplicates</h3>
<p>Ok great! We know how to select, rename, and modify our data. Another task we will often need to do is removing duplicate entries. Fortunately this one is easily done using the function <code>distinct()</code>, which has the following basic syntax:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DO NOT RUN (PSEUDO-CODE)</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that distinct only needs one argument by default, the dataset itself. This will look for and remove any duplicate observations in the data frame. There are some fancier ways of using <code>distinct()</code> that will look for duplication on certain variables only, but that’s outside of the scope of today’s session.</p>
<div class="write">
<p>Use <code>distinct()</code> to create a temporary data frame, <code>tmp</code>, that contains all the unique observations in <code>df_raw</code>. Compare the number of rows in <code>tmp</code> to that of <code>df_raw</code>. Did we have any duplicates?</p>
</div>
</section>
</section>
<section id="the-pipe-operator" class="level2">
<h2 class="anchored" data-anchor-id="the-pipe-operator">The Pipe Operator</h2>
<p>So it looks like we have actually done quite a bit of cleaning while learning the core <code>{dplyr}</code> verbs. We should probably try to put some of the above steps together to start building a basic data cleaning pipeline. So far we haven’t been saving any of our changes, except perhaps to a temporary data frame. It would be nice to keep them in a new clean <code>df</code> object.</p>
<p>For example, if we want to effect the column renaming we did above to a reusable object we might write something like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">rename</span>(df_raw, </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">prefecture =</span> sub_prefecture,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">village =</span> village_commune,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">facility =</span> health_facility_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>In general, it’s good practice to keep a raw version of your dataset, here <code>df_raw</code>, that remains unmodified in your code. This is so that you always have it available in your environment as a reference and is always available at the start of your cleaning pipeline to improve reproducibility.</p>
</div>
</div>
<p>Now we have a new object, <code>df</code> that we can do more operations on. Brilliant. For example, if we now wanted to select everything except for <code>full_name</code> we could update the above code like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Rename Variables</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">rename</span>(df_raw, </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">prefecture =</span> sub_prefecture,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">village =</span> village_commune,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">facility =</span> health_facility_name)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Select Variables to Keep</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">select</span>(df,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>             <span class="sc">-</span>full_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that in this second step we are using <code>df</code> as the input of <code>select()</code> rather than <code>df_raw</code> because we want to continue working on our modified version of the data. Let’s say now we want to add a column of age in years:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Rename Variables</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">rename</span>(df_raw, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">prefecture =</span> sub_prefecture,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">village =</span> village_commune,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">facility =</span> health_facility_name)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Select Variables to Keep</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">select</span>(df,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>             <span class="sc">-</span>full_name)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Add Age in Years</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">mutate</span>(df,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">age_years =</span> age <span class="sc">/</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Hm, ok well this is working but it is starting to get repetitive. With each step we are reusing the output of the last step and then updating the same data frame, <code>df</code>. It would be better if these actions could be chained together in a simpler way.</p>
<p>This is exactly what the pipe operator, <code>|&gt;</code> is for! The pipe has the following basic syntax:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DO NOT RUN (PSEUDO-CODE)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>input <span class="sc">|&gt;</span> <span class="fu">action</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here the input on the left side (<code>input</code>) is “piped into” the action on the right side (<code>action()</code>). So for example instead of writing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(df_raw, id, sex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could instead write:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>df_raw <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, sex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="write">
<p>Try out the above code to see if it works.</p>
</div>
<p>This can be used to chain multiple actions together and you will often see tidyverse style code that uses pipes in the following way:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DO NOT RUN (PSEUDO-CODE)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df_raw <span class="sc">|&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">first_action</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">second_action</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">third_action</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Notice that here each action in the pipe is given its own line. This is considered good practice as it makes your code easier to read and understand.</p>
</div>
</div>
<p>So, if we wanted to chain the example actions we saw above into a single pipe, we might write something like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df_raw <span class="sc">|&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">prefecture =</span> sub_prefecture,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">village =</span> village_commune,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">facility =</span> health_facility_name) <span class="sc">|&gt;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>full_name) <span class="sc">|&gt;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age_years =</span> age <span class="sc">/</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>That’s a lot easier than reassigning <code>df</code> after each step!</p>
<div class="write">
<p>Let’s see if we can put together what we learned above into a single pipeline! Use the pipe operator <code>|&gt;</code>, <code>select()</code>, <code>rename()</code>, <code>mutate()</code>, <code>str_to_title()</code>, <code>ymd()</code>, and <code>distinct()</code> to perform the following actions on <code>df_raw</code> and assign the output to a new data frame called <code>df</code>:</p>
<ul>
<li>Remove the variables <code>full_name</code> and <code>age_unit</code></li>
<li>Rename the following variables:
<ul>
<li><code>age</code> becomes <code>age_months</code></li>
<li><code>sub_prefecture</code> becomes <code>prefecture</code></li>
<li><code>village_commune</code> becomes <code>village</code></li>
<li><code>health_facility_name</code> becomes <code>facility</code></li>
</ul></li>
<li>Add a variable <code>age_years</code> with patient age in years</li>
<li>Update <code>region</code> and <code>prefecture</code> to use title case</li>
<li>Update all date columns to use <code>Date</code> type</li>
<li>Remove any duplicate observations</li>
</ul>
<p>The head of your final data should look something like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>  id   sex age_months  region prefecture        village date_onset
1  1 femme         36 Mandoul   Moissala Sangana Koïtan 2022-08-13
2  2     f          5 Mandoul   Moissala      Mousdan 1 2022-08-18
3  3     f        156 Mandoul   Moissala     Djaroua Ii 2022-08-17
4  6 homme          8 Mandoul   Moissala     Monakoumba 2022-08-22
5  7     m          7 Mandoul   Moissala      Tétindaya 2022-08-30
6 10     m          4 Mandoul   Moissala      Danamadja 2022-08-30
  date_consultation hospitalisation date_admission
1        2022-08-14             yes     2022-08-14
2        2022-08-25             yes     2022-08-25
3        2022-08-20            &lt;NA&gt;           &lt;NA&gt;
4        2022-08-25              no           &lt;NA&gt;
5        2022-09-02              no           &lt;NA&gt;
6        2022-09-02             yes     2022-09-02
                         facility malaria_rdt fever rash cough red_eye
1 Hôpital du District de Moissala    negative    No &lt;NA&gt;   Yes      No
2 Hôpital du District de Moissala    negative    No   No   Yes      No
3                      CS Silambi    negative   Yes &lt;NA&gt;    No      No
4 Hôpital du District de Moissala    negative    No   No    No    &lt;NA&gt;
5                      CS Silambi    negative  &lt;NA&gt;   No   Yes     Yes
6                    Moissala Est    negative   Yes   No    No    &lt;NA&gt;
  pneumonia encephalitis muac vacc_status vacc_doses   outcome date_outcome
1        No           No  244        &lt;NA&gt;       &lt;NA&gt; recovered   2022-08-18
2      &lt;NA&gt;           No  232          No       &lt;NA&gt;      &lt;NA&gt;   2022-08-28
3        No         &lt;NA&gt;  123  Yes - oral       &lt;NA&gt; recovered         &lt;NA&gt;
4        No           No  210          No       &lt;NA&gt; recovered         &lt;NA&gt;
5        No           No   80          No       &lt;NA&gt; recovered         &lt;NA&gt;
6        No           No  220          No       &lt;NA&gt; recovered   2022-09-03
   age_years
1  3.0000000
2  0.4166667
3 13.0000000
4  0.6666667
5  0.5833333
6  0.3333333</code></pre>
</div>
</div>
<p><strong>Hint.</strong> Be careful with your column names here! If you renamed something you will need to use the new names for any subsequent parts of the pipe.</p>
</div>
<p>Amazing! That looks like a great start at a data cleaning pipeline. Keep this code handy, you will use it in the next session where we will look at another common part of data cleaning: <strong>recoding</strong>.</p>
</section>
<section id="done" class="level2">
<h2 class="anchored" data-anchor-id="done">Done!</h2>
<p>Well done, you’ve learned the fundamentals of data manipulation and how to string multiple commands together into a data manipulation pipe. Moving forward, solution files will focus less on being “exercise by exercise” and rather provide an example of what a real script might look like in a real world context. In this case, the solutions will then focus only on the final pipe that is created at the end of the session.</p>
<div class="cell">
<div class="cell-output-display">
<a href="https://github.com/epicentre-msf/repicentre/blob/main/sessions_core/03_data-verbs_solutions.R">
<button class="btn btn-default"><i class="fa fa-save"></i> Solution File</button>
</a>
</div>
</div>
</section>
<section id="going-further" class="level2">
<h2 class="anchored" data-anchor-id="going-further">Going Further</h2>
<section id="extra-exercises" class="level3">
<h3 class="anchored" data-anchor-id="extra-exercises">Extra Exercises</h3>
<ol type="1">
<li><p>A a line to your <code>mutate()</code> to update the <code>hospitalisation</code> variable so that its text would be in title case as well.</p></li>
<li><p>Perhaps you would prefer to use lower case for the <code>region</code> column rather than the title case, update your code to do this instead. <strong>Hint</strong>: you might want to check out <code>str_to_lower()</code> from <code>{stringr}</code>.</p></li>
<li><p>Create a <code>delay_consultation</code> column, that contains the number of days between the onset of symptoms and the consultation.</p></li>
</ol>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>
